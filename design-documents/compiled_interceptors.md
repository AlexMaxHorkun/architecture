## Compiled Interceptors

Proposal based on Community Pull Request https://github.com/magento/magento2/pull/22826 created by [@fsw](https://github.com/fsw)

### Overview

The idea is to use a mechanism which generates Interceptors code using app config instead of reading config at runtime.
Main benefit of having this approach incorporated to Magento is improving Dev Experience while debuggind and profiling Magento codebase.

#### Current Code generated Interceptors

```php
public function methodX($arg) {
    $pluginInfo = $this->pluginList->getNext($this->subjectType, 'methodX');
    if (!$pluginInfo) {
        return parent::methodX($arg);
    } else {
        return $this->___callPlugins('methodX', func_get_args(), $pluginInfo);
    }
}
```

#### Proposed version of Code generated Interceptors 

```php
public function methodX($arg) {
    switch(getCurrentScope()){
        case 'frontend':
            $this->_get_example_plugin()->beforeMethodX($this, $arg);
            $this->_get_another_plugin()->beforeMethodX($this, $arg);
            $result = $this->_get_around_plugin()->aroundMethodX($this, function($arg){
                return parent::methodX($arg);
            });
            return $this->_get_after_plugin()->afterMethodX($this, $result);
        case 'adminhtml':
            // ...
        default:
            return parent::methodX($arg);
    }
}
```

### Design

The main idea is to compile the Interceptor using information from source code. 
This makes plugins slightly faster (as we no need to resolve all plugins dinamically). 
This is important in places where there is a lot of non-cached PHP logic going on (for example admin panel).

Having plugins called directly also makes code easier to debug. The Interceptors generated by this approach are fully compatible with the ones generated by Magento 
currently, so there is no need to change anything in existing plugins.


#### PROS

1. Easier Debugging process as there is no anymore dynamic method execution via `___callPlugins` (No  calls to ___callPlugins in call stack).
2. Slightly Faster response time for uncached code in production mode 

#### CONS 

1. Each time after making change in etc plugins config, generated/code/* needs to be purged
2. Longer code generation step
3. Longer time for first request and corresponding generation in Dev Mode

#### Extension Points and Scenarios

<!-- In this section describe customization points that can be used by third party developers to customize behavior described in design -->

### Discusssions and Public Involvements

- [YouTube recording of Architectural Discussion](https://www.youtube.com/watch?v=no2jVn_mixk&list=PLDvMskiz68Q3ZVyRsc59IjEqX85LaO8mr&index=16)
- https://github.com/creatuity/magento2-interceptors

