# Detailed architecture of multi-service Magento

:warning: This document is under discussion and is incomplete.

## Overview

TBD

## Authentication, Store and Customer contexts

**Auth JWT** - authentication token, which contains encrypted customer ID and is used on GraphQL Server to authenticate the logged-in customers.
 This token is generated by the store front authentication server in response to the request containing valid customer credentials.
 Customer ID is not encrypted and is visible to all parties including the client application.

**Customer Context JWT** - contains encrypted customer data, which should be used for cache key generation and MUST not be modifiable by the client due to its sensitivity. Examples include customer group and customer segment. 
 Customer Context MUST not include any customer data not relevant for cache scoping, for example customer ID. The token can be used as is for cache key generation and does not require parsing by caching layer. 
 This token is generated by GraphQL Server and the list of customer data included in the token must be extensible. The data itself is encrypted and decrypted by GraphQL server only, encryption secret MUST NOT be shared with any other services. 

**Token Service** - authentication and customer context tokens will be signed with private key by the Token service, this private key MUST NOT be shared with any other services. All other parties will be able to validate signature using public key. 
 
**Store Context** - a set of headers that contain scoping information applicable to the majority of the queries. Examples include store code and currency. These headers are optional. The client application is responsible for tracking scoping values selected by the customer and sending them with all subsequent requests in headers.

Auth JWT, Customer Context JWT and Store Context are all optional, however, when present in the original client request, they MUST be retransmitted along with all subsequent calls to Magento services. They should not be retransmitted with the calls to the third-party systems.
 
## Query enrichment

When the user visits Magento storefront for the first time, pages that support scoping (like category page) must be rendered based on default scopes.
Client application may send query with no currency, store code and customer context. At the same time, catalog store front API requires store code, currency and customer group to be passed as explicit arguments. 
The solution is to have GraphQL query enriched by the GraphQL server. Enrichment logic cannot be moved to store front gateway because of couple reasons:
 - it requires GraphQL query to be parsed
 - it relies on customer context arguments to be decoded. This can be done only by GraphQL server which owns corresponding encoding secret
 
Data lookup for store front API query enrichment will be done using the following sources in the specified order:
 1. Customer ID will always be taken from the Authentication JWT
 1. Customer group, customer segment and any extensions to the customer context will always be taken from the Customer Context JWT
 1. Data from GraphQL query body
 1. Data from store context headers
 1. Defaults from GraphQL Server cache
 1. Preconfigured defaults via calls to storefront services. For example, default customer group based on current store code. The list of defaults with corresponding sources MUST be configurable
 
![Gateway](img/GraphQL%20BFF.png)

![Customer authentication](img/BFF%20-%20Customer%20Authentication%20Sequence.png)

![Product details page](img/PWA%20BFF%20-%20Product%20Page%20Sequence.png)
